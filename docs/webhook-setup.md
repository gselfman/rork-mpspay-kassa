## Настройка обработки вебхуков MPSPAY

### Обзор
Для корректной обработки уведомлений о статусе платежей от MPSPAY необходимо настроить сервер для приема вебхуков (callback-запросов). Этот документ описывает процесс настройки и интеграции.

### Шаги настройки

1. **Развертывание сервера вебхуков**

   Файл `server/webhook-handler.js` содержит базовую реализацию сервера для обработки вебхуков. Вы можете развернуть его одним из следующих способов:

   - **Как отдельный Express.js сервер**:
     ```bash
     cd server
     npm install express body-parser
     node webhook-handler.js
     ```

   - **Как serverless функцию** (Vercel, Netlify, AWS Lambda):
     - Для Vercel: создайте файл `api/webhook.js` с содержимым из `webhook-handler.js`
     - Для AWS Lambda: используйте AWS API Gateway + Lambda
     - Для Firebase: используйте Firebase Functions

2. **Настройка URL для колбэков**

   После развертывания сервера вебхуков, обновите константу `WEBHOOK_BASE_URL` в файле `utils/api.ts`:

   ```typescript
   const WEBHOOK_BASE_URL = 'https://your-domain.com/api/mpspay-callback';
   ```

   Замените `your-domain.com` на реальный домен, где размещен ваш сервер вебхуков.

3. **Структура данных колбэка**

   MPSPAY отправляет колбэки со следующей структурой данных:

   ```json
   {
     "id": 12345,           // ID платежа в системе MPSPAY
     "status": 3,           // Статус платежа (3 = успешно, 2 = отменен, 1 = в обработке)
     "amount": 100,         // Сумма платежа
     "currency": 112,       // Код валюты
     "orderId": "20230101123456" // Ваш ID заказа/транзакции
   }
   ```

4. **Интеграция с вашим приложением**

   Для полной интеграции необходимо реализовать механизм обновления статуса транзакций в вашем приложении. Варианты:

   - **Использование Firebase Realtime Database или Firestore**:
     ```javascript
     // В webhook-handler.js
     const admin = require('firebase-admin');
     admin.initializeApp();
     
     // Обновление статуса транзакции
     async function updateTransactionStatus(transactionId, status) {
       await admin.firestore().collection('transactions').doc(transactionId).update({
         status: status,
         updatedAt: admin.firestore.FieldValue.serverTimestamp()
       });
     }
     ```

   - **Использование REST API**:
     Создайте защищенный API эндпоинт в вашем приложении для обновления статуса транзакций.

### Безопасность

1. **Проверка подлинности запросов**:
   - Добавьте проверку IP-адресов (разрешайте только запросы от MPSPAY)
   - Реализуйте механизм подписи запросов (если поддерживается MPSPAY)
   - Используйте HTTPS для всех запросов

2. **Защита от повторных запросов**:
   - Проверяйте, не был ли уже обработан данный колбэк
   - Используйте идемпотентные операции при обновлении статуса

### Тестирование

1. Используйте инструменты типа Postman или curl для отправки тестовых запросов на ваш вебхук-сервер
2. Проверьте логи сервера для подтверждения получения запросов
3. Убедитесь, что статусы транзакций корректно обновляются в вашем приложении

### Мониторинг

Настройте мониторинг для вашего вебхук-сервера:
- Логирование всех входящих запросов
- Оповещения о сбоях в работе сервера
- Регулярные проверки доступности сервера